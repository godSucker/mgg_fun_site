---
import BaseLayout from '../../layouts/BaseLayout.astro';
import MaterialsTable from '../../components/materials/MaterialsTable.astro';
import materialData from '../../data/materials/material.json';
import charmsData from '../../data/materials/charms.json';
import orbsDataRaw from '../../data/materials/orbs.json';
import buildingsData from '../../data/materials/buildings.json';
import sourcesMap from '../../data/materials/sources.json';
import { getItemTexture } from '../../lib/craft-simulator';

function withTexture(item){
  const id = String(item?.id || '').trim();
  const name = item?.name || id;
  const description = item?.description || '';
  const percent = item?.percent ?? item?.pct ?? null;
  const value = item?.value ?? null;
  const rarity = item?.rarity ?? null;

  let tex = getItemTexture(id);
  if (!tex) {
    // если это токен — грузим из /tokens/event_tokens/
    if (/token/i.test(id) || id === 'Daily_Token') {
      tex = `/tokens/event_tokens/${id}.png`;
    } else {
      tex = `/materials/${id}.png`;
    }
  }

  return { id, name, description, percent, value, rarity, texture: tex };
}

const orbsData = (Array.isArray(orbsDataRaw) ? orbsDataRaw : []).filter((o) => {
  const id = String(o?.id || '').toLowerCase();
  return id && !id.includes('ephemeral');
});

const materialsRows = (Array.isArray(materialData) ? materialData : []).map(withTexture);
const charmsRows    = (Array.isArray(charmsData) ? charmsData : []).map(withTexture);
const orbsRows      = (Array.isArray(orbsData) ? orbsData : []).map(withTexture);

// Buildings: держим как есть; текстуры будем искать в /buildings/<ID>.png
const buildingsRows = (Array.isArray(buildingsData) ? buildingsData : []).map((b) => ({
  id: String(b?.id || '').trim(),
  name: b?.name || (b?.id || ''),
  description: b?.description || '',
  texture: `/buildings/${b?.id}.png`
}));

const TABS = [
  { key: 'orbs', label: 'Сферы' },
  { key: 'charms', label: 'Бустеры' },
  { key: 'materials', label: 'Материалы' },
  { key: 'buildings', label: 'Здания' },
];
const DEFAULT_TAB = 'materials';
---

<BaseLayout title="Материалы и ресурсы">
  <section class="intro">
    <h1>Материалы и ресурсы</h1>
    <p>Выбери раздел: сферы, бустеры, материалы или здания. Все предметы показаны с текстурами и описаниями; источники добычи настраиваются в <code>src/data/materials/sources.json</code>.</p>
  </section>

  <nav class="tabs" aria-label="Разделы материалов">
    {TABS.map((t) => (
      <button
        class="tab-btn"
        type="button"
        data-tab={t.key}
        aria-controls={`section-${t.key}`}
      >
        {t.label}
      </button>
    ))}
  </nav>

  <section id="section-orbs" class="tab-section" data-tab="orbs" hidden>
    <MaterialsTable rows={orbsRows} sourcesMap={sourcesMap} title="Сферы" />
  </section>

  <section id="section-charms" class="tab-section" data-tab="charms" hidden>
    <MaterialsTable rows={charmsRows} sourcesMap={sourcesMap} title="Бустеры" />
  </section>

  <section id="section-materials" class="tab-section" data-tab="materials" hidden>
    <MaterialsTable rows={materialsRows} sourcesMap={sourcesMap} title="Материалы" />
  </section>

  <section id="section-buildings" class="tab-section" data-tab="buildings" hidden>
    <MaterialsTable rows={buildingsRows} sourcesMap={sourcesMap} title="Здания" texturePrefix="/buildings/" textureExt=".png" />
  </section>
</BaseLayout>

<script>
  (function(){
    const qs = (s,d=document)=>d.querySelector(s);
    const qsa = (s,d=document)=>Array.from(d.querySelectorAll(s));
    const tabs = qsa('.tab-btn');
    const sections = qsa('.tab-section');
    const url = new URL(window.location.href);
    const fromUrl = (url.searchParams.get('tab') || window.location.hash.replace('#','') || '').trim().toLowerCase();
    let active = fromUrl || 'materials';

    function showTab(key){
      active = key;
      for(const b of tabs){
        const on = b.dataset.tab === key;
        b.classList.toggle('active', on);
        b.setAttribute('aria-pressed', String(on));
      }
      for(const s of sections){
        const on = s.dataset.tab === key;
        s.hidden = !on;
      }
      const u = new URL(window.location.href);
      u.searchParams.set('tab', key);
      history.replaceState(null, '', u.toString());
    }

    tabs.forEach((b)=>b.addEventListener('click', ()=>showTab(b.dataset.tab)));
    if(!tabs.some((b)=>b.dataset.tab===active)) active = 'materials';
    showTab(active);
  })();
</script>

<style>
  .intro { margin-bottom: 1rem; }
  .intro h1 {
    margin: 0 0 0.5rem;
    font-size: clamp(1.5rem, 1.1rem + 1.1vw, 2.2rem);
    color: #f8fafc;
  }
  .intro p { margin: 0; color: #94a3b8; }

  .tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }
  .tab-btn {
    appearance: none;
    border: 1px solid rgba(96, 165, 250, 0.28);
    background: rgba(15, 23, 42, 0.92);
    color: #e2e8f0;
    border-radius: 999px;
    padding: 0.5rem 0.9rem;
    font-size: 0.95rem;
    letter-spacing: 0.03em;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, background 0.2s ease;
  }
  .tab-btn:hover {
    transform: translateY(-2px);
    border-color: rgba(96, 165, 250, 0.6);
    box-shadow: 0 10px 18px rgba(37, 99, 235, 0.22);
  }
  .tab-btn.active {
    background: linear-gradient(180deg, rgba(30, 58, 138, 0.3), rgba(15, 23, 42, 0.92));
    border-color: rgba(96, 165, 250, 0.65);
    box-shadow: 0 12px 24px rgba(37, 99, 235, 0.22);
  }

  .tab-section { margin-top: 0.5rem; }
</style>
