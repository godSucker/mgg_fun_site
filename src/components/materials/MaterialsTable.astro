---
export interface SourceInfo {
  type: string;
  where?: string;
  note?: string;
  link?: string;
}

export interface MaterialRow {
  id: string;
  name: string;
  description?: string;
  texture?: string;
  percent?: string;
  value?: string;
  rarity?: string;
}

interface Props {
  rows: MaterialRow[];
  sourcesMap?: Record<string, SourceInfo[]>;
  title?: string;
  texturePrefix?: string;
  textureExt?: string;
}

const {
  rows,
  sourcesMap = {},
  title = '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã',
  texturePrefix = '/materials/',
  textureExt = '.webp'
} = Astro.props;

const resolveTexture = (row: MaterialRow) => row.texture ? row.texture : `${texturePrefix}${row.id}${textureExt}`;

const toChip = (s: SourceInfo) => {
  const iconByType: Record<string, string> = {
    reactor: '‚öõÔ∏è',
    gacha: 'üé∞',
    jackpot: 'üéüÔ∏è',
    event: 'üéâ',
    shop: 'üõí',
    pvp: '‚öîÔ∏è',
    story: 'üìú',
    dungeon: 'üï≥Ô∏è',
    raid: 'üê≤',
    lab: 'üß™',
    bingo: 'üéØ',
    division: 'üèÜ',
    other: 'üì¶',
  };
  const icon = iconByType[s.type] ?? 'üì¶';
  const where = s.where ? ` ‚Äî ${s.where}` : '';
  const note = s.note ? ` (${s.note})` : '';
  return `${icon} ${s.type}${where}${note}`;
};
---

<section class="materials" data-title={title}>
  <div class="header">
    <h2>{title}</h2>
    <div class="controls">
      <input class="mat-search" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é/–æ–ø–∏—Å–∞–Ω–∏—é‚Ä¶" />
    </div>
  </div>

  <div class="table" role="table" aria-label={title}>
    <div class="thead" role="rowgroup">
      <div class="tr" role="row">
        <div class="th image" role="columnheader">–¢–µ–∫—Å—Ç—É—Ä–∞</div>
        <div class="th name" role="columnheader">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
        <div class="th desc" role="columnheader">–û–ø–∏—Å–∞–Ω–∏–µ</div>
        <div class="th srcs" role="columnheader">–ì–¥–µ –¥–æ–±—ã—Ç—å</div>
      </div>
    </div>

    <div class="tbody" role="rowgroup">
      {rows.map((row) => {
        const srcs = sourcesMap[row.id] ?? [];
        return (
          <div class="tr" role="row" data-id={row.id}>
            <div class="td image" role="cell">
              <div class="thumb">
                <img
                  src={resolveTexture(row)}
                  alt={row.name || row.id}
                  loading="lazy"
                  onerror="this.closest('.thumb').classList.add('noimg')"
                />
              </div>
            </div>
            <div class="td name" role="cell">
              <div class="name-wrap">
                <strong class="title">{row.name || row.id}</strong>
                <span class="meta">
                  {row.percent && <span class="tag">% {row.percent}</span>}
                  {row.value && <span class="tag">+{row.value}</span>}
                  {row.rarity && <span class="tag">{row.rarity}</span>}
                </span>
              </div>
            </div>
            <div class="td desc" role="cell">
              {row.description ? row.description : <span class="muted">–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ</span>}
            </div>
            <div class="td srcs" role="cell">
              {srcs.length > 0 ? (
                <div class="chips">
                  {srcs.map((s) => (
                    s.link ? (
                      <a href={s.link} class="chip linkable" title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏">{toChip(s)}</a>
                    ) : (
                      <span class="chip">{toChip(s)}</span>
                    )
                  ))}
                </div>
              ) : (
                <span class="muted">‚Äî</span>
              )}
            </div>
          </div>
        );
      })}
    </div>
  </div>
</section>

<script is:inline>
  (function(){
    // Normalize search string: lowercase + remove special chars
    function normalizeSearch(text) {
      if (!text) return '';
      return text
        .toLowerCase()
        .replace(/[^\w\u0400-\u04FF]/g, ''); // Keep only word chars and Cyrillic
    }

    function wire(root){
      if (!root || root.dataset.searchReady === '1') return;
      const input = root.querySelector('.mat-search');
      const body  = root.querySelector('.tbody');
      if (!input || !body) { root.dataset.searchReady = '1'; return; }
      const rows  = Array.from(body.querySelectorAll('.tr'));

      function apply(){
        const q = normalizeSearch(input.value || '');
        for (const r of rows) {
          const id = normalizeSearch(r.getAttribute('data-id') || '');
          const text = normalizeSearch(r.textContent || '');
          const match = !q || id.includes(q) || text.includes(q);
          r.style.display = match ? '' : 'none';
        }
      }
      input.addEventListener('input', apply);
      root.dataset.searchReady = '1';
      apply();
    }

    function init(){
      document.querySelectorAll('.materials').forEach(wire);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init, { once:true });
    } else {
      init();
    }
  })();
</script>

<style>
  .materials { margin-top: 1rem; }

  .header {
    display: flex; align-items: center; justify-content: space-between;
    gap: 1rem; margin-bottom: 1rem;
  }
  .header h2 { margin: 0; font-size: clamp(1.2rem, 1rem + 1vw, 1.6rem); color: #e2e8f0; }
  .controls { display: flex; gap: 0.75rem; }
  .controls input[type="search"] {
    height: 40px; border-radius: 12px; border: 1px solid rgba(96, 165, 250, 0.28);
    background: rgba(15, 23, 42, 0.92); color: #e2e8f0; padding: 0 0.8rem;
  }
  .controls input::placeholder { color: #94a3b8; }

  .table {
    border: 1px solid rgba(96, 165, 250, 0.28);
    background: rgba(15, 23, 42, 0.92);
    border-radius: 16px;
    overflow: hidden;
  }

  /* Default layout */
  .thead .tr, .tbody .tr {
    display: grid;
    grid-template-columns: 92px minmax(200px, 1fr) minmax(260px, 2fr) minmax(220px, 1.4fr);
    gap: 0;
  }

  /* Bigger image column for Buildings with no cropping */
  .materials[data-title="–ó–¥–∞–Ω–∏—è"] .thead .tr,
  .materials[data-title="–ó–¥–∞–Ω–∏—è"] .tbody .tr {
    grid-template-columns: 160px minmax(200px, 1fr) minmax(260px, 2fr) minmax(220px, 1.4fr);
  }

  .thead .tr {
    background: linear-gradient(180deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.8));
    position: sticky; top: 0; z-index: 1;
    border-bottom: 1px solid rgba(96, 165, 250, 0.28);
  }
  .th, .td { padding: 0.9rem 1rem; border-bottom: 1px solid rgba(96, 165, 250, 0.12); }
  .th { font-weight: 600; color: #9ec5fe; font-size: 0.9rem; }

  .tbody .tr:hover { background: rgba(30, 58, 138, 0.18); }

  .thumb {
    width: 84px;
    height: auto;
    border-radius: 14px;
    overflow: visible;
    position: relative;
    padding: 10px; box-sizing: border-box;
    background:
      radial-gradient(60% 60% at 30% 30%, rgba(59, 130, 246, 0.18), transparent 60%),
      radial-gradient(60% 60% at 70% 70%, rgba(147, 197, 253, 0.15), transparent 60%),
      linear-gradient(180deg, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.95));
    display: grid; place-items: center;
  }

  /* Larger thumbs for Buildings (no crop, fully visible) */
  .materials[data-title="–ó–¥–∞–Ω–∏—è"] .thumb {
    width: 140px;
    height: auto;
    padding: 12px;
    border-radius: 16px;
  }

  .thumb img {
    max-width: 100%;
    max-height: 180px;
    width: auto;
    height: auto;
    display: block;
    margin: auto;
    object-fit: contain;
    object-position: center;
    image-rendering: auto;
    transform: translateZ(0);
  }

  .materials[data-title="–ó–¥–∞–Ω–∏—è"] .thumb img {
    max-height: 200px;
  }

  .thumb.noimg::after { content: 'No image'; color: #64748b; font-size: 0.7rem; letter-spacing: 0.06em; }

  .name .title { color: #e2e8f0; }
  .meta { display: inline-flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 0.35rem; }

  .tag {
    background: rgba(59, 130, 246, 0.15); color: #bfdbfe;
    padding: 0.1rem 0.5rem; border-radius: 999px; font-size: 0.78rem; letter-spacing: 0.04em;
  }

  .muted { color: #94a3b8; }

  .chips { display: flex; flex-wrap: wrap; gap: 0.4rem; }
  .chip {
    background: rgba(34, 197, 94, 0.16); color: #a7f3d0;
    border: 1px solid rgba(16, 185, 129, 0.25);
    padding: 0.2rem 0.55rem; border-radius: 999px; font-size: 0.78rem;
    text-decoration: none;
    transition: all 0.2s;
  }
  
  .chip.linkable:hover {
    background: rgba(34, 197, 94, 0.3);
    border-color: rgba(16, 185, 129, 0.5);
    color: #ecfdf5;
    cursor: pointer;
    box-shadow: 0 0 10px rgba(16, 185, 129, 0.2);
  }

  /* === Orbs & Boosters sizing normalization === */
  /* –í—Å–µ —Ç–µ–∫—Å—Ç—É—Ä—ã (—Å—Ñ–µ—Ä—ã, –±—É—Å—Ç–µ—Ä—ã, –º–∞—Ç–µ—Ä–∏–∞–ª—ã) —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Å–∫—Ä–∏–ø—Ç–æ–º normalize-boosters.py
     –∫ –µ–¥–∏–Ω–æ–º—É –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–º—É —Ö–æ–ª—Å—Ç—É 256x256 —Å –∞–≤—Ç–æ–æ–±—Ä–µ–∑–∫–æ–π –ø—É—Å—Ç–æ—Ç—ã.
     –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç 100% –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤. */

  .materials[data-title="–°—Ñ–µ—Ä—ã"] .thumb,
  .materials[data-title="–ë—É—Å—Ç–µ—Ä—ã"] .thumb {
    width: var(--orb-size-container-large);
    height: var(--orb-size-container-large);
    padding: 8px;
    flex-shrink: 0;
  }

  .materials[data-title="–°—Ñ–µ—Ä—ã"] .thumb img,
  .materials[data-title="–ë—É—Å—Ç–µ—Ä—ã"] .thumb img {
    width: var(--orb-size-img-large);
    height: var(--orb-size-img-large);
    object-fit: contain;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.45));
  }

  @media (max-width: 980px) {
    .thead .tr, .tbody .tr { grid-template-columns: 92px minmax(160px, 1fr) minmax(200px, 2fr) minmax(160px, 1.2fr); }
    .materials[data-title="–ó–¥–∞–Ω–∏—è"] .thead .tr,
    .materials[data-title="–ó–¥–∞–Ω–∏—è"] .tbody .tr { grid-template-columns: 150px minmax(160px, 1fr) minmax(200px, 2fr) minmax(160px, 1.2fr); }
    .th, .td { padding: 0.75rem 0.8rem; }
  }
  @media (max-width: 720px) {
    .thead { display: none; }
    .tbody .tr {
      grid-template-columns: 92px 1fr;
      grid-auto-rows: auto; gap: 0.25rem 0.8rem;
      padding: 0.6rem 0.2rem; border-bottom: 1px solid rgba(96, 165, 250, 0.12);
    }
    .materials[data-title="–ó–¥–∞–Ω–∏—è"] .tbody .tr {
      grid-template-columns: 150px 1fr;
    }
    .td.name { grid-column: 2 / -1; }
    .td.desc { grid-column: 1 / -1; padding-top: 0; }
    .td.srcs { grid-column: 1 / -1; padding-top: 0; }

    /* Bug fix #9: Fixed orb sizes on mobile to match desktop */
    .materials[data-title="–°—Ñ–µ—Ä—ã"] .thumb,
    .materials[data-title="–ë—É—Å—Ç–µ—Ä—ã"] .thumb {
      width: var(--orb-size-container-large);
      height: var(--orb-size-container-large);
      padding: 8px;
      flex-shrink: 0;
    }

    .materials[data-title="–°—Ñ–µ—Ä—ã"] .thumb img,
    .materials[data-title="–ë—É—Å—Ç–µ—Ä—ã"] .thumb img {
      width: var(--orb-size-img-large);
      height: var(--orb-size-img-large);
      object-fit: contain;
    }
  }

  /* QHD upscaling */
  @media (min-width: 1921px) {
    .thumb { width: 105px; padding: 12px; }
    .thumb img { max-height: 225px; }
    .materials[data-title="–ó–¥–∞–Ω–∏—è"] .thumb { width: 175px; padding: 15px; }
    .materials[data-title="–ó–¥–∞–Ω–∏—è"] .thumb img { max-height: 250px; }
    .materials[data-title="–°—Ñ–µ—Ä—ã"] .thumb,
    .materials[data-title="–ë—É—Å—Ç–µ—Ä—ã"] .thumb {
      width: calc(var(--orb-size-container-large) * 1.25);
      height: calc(var(--orb-size-container-large) * 1.25);
      padding: 10px;
    }
    .materials[data-title="–°—Ñ–µ—Ä—ã"] .thumb img,
    .materials[data-title="–ë—É—Å—Ç–µ—Ä—ã"] .thumb img {
      width: calc(var(--orb-size-img-large) * 1.25);
      height: calc(var(--orb-size-img-large) * 1.25);
    }
  }
</style>
