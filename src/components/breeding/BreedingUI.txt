<script lang="ts">
  import { secretCombos } from '@/lib/secretCombos';
  import mutantsData from '@/data/mutants/normal.json';
  import { calculateBreeding, findParentsFor, type Mutant } from '@/lib/breeding/breeding';

  // 1. DATA
  const allMutants = (mutantsData as any[]).map(m => ({
    ...m,
    id: String(m.id),
    odds: Number(m.odds) || 0
  })) as unknown as Mutant[];

  const normalize = (n: string) => n.toLowerCase().replace(/[^a-z0-9–∞-—è—ë]/g, '');
  const secretNames = new Set(secretCombos.map(s => normalize(s.childName)));

  // 2. HELPERS
  const getName = (m: any) => m.name || m.id;

  function getImageSrc(m: any): string {
    const img = m.image;
    const path = Array.isArray(img) ? (img[1] ?? img[0]) : img;
    return path.startsWith('/') ? path : '/' + path;
  }

  function getGeneIconSrc(ch: string): string {
    const l = ch.toLowerCase();
    return ['a','b','c','d','e','f'].includes(l) ? `/genes/icon_gene_${l}.webp` : `/genes/gene_all.webp`;
  }

  function getTypeIcon(m: any): string {
    const t = (m.type ?? '').toLowerCase();
    if (t.includes('legend')) return '/mut_icons/icon_legendary.webp';
    if (!t || t === 'default') return '/mut_icons/icon_morphology.webp';
    return `/mut_icons/icon_${t}.webp`;
  }

  function formatTime(val: any) {
    const m = Number(val);
    if (!m || m <= 0) return '-';
    if (m < 60) return `${m}–º`;
    const h = Math.floor(m / 60);
    const min = m % 60;
    return min > 0 ? `${h}—á ${min}–º` : `${h}—á`;
  }

  // 3. STATE
  let mode: 'calc' | 'reverse' = 'calc';
  let p1: Mutant | null = null;
  let p2: Mutant | null = null;
  let target: Mutant | null = null;
  let level: string = '3'; // Decorative
  let search = '';
  let filterGene = 'all';

  // 4. LOGIC
  $: filteredList = (() => {
    if (filterGene === 'recipe') {
        return allMutants.filter(m => secretNames.has(normalize(getName(m))));
    }
    return allMutants.filter(m => {
        const geneMatch = filterGene === 'all' || (Array.isArray(m.genes) && m.genes.some((g: string) => g.includes(filterGene)));
        const nameMatch = getName(m).toLowerCase().includes(search.toLowerCase());
        return geneMatch && nameMatch;
    }).sort((a, b) => getName(a).localeCompare(getName(b), 'ru'));
  })();

  // CALC
  let calcResults: any[] = [];
  let minTime = '';

  $: if (mode === 'calc' && p1 && p2) {
    const res = calculateBreeding(p1, p2, allMutants); // –ë–µ–∑ —É—Ä–æ–≤–Ω—è
    calcResults = res.map(r => ({
      ...r.child,
      isSecret: r.isSecret,
      tag: r.isSecret ? '–†–ï–¶–ï–ü–¢' : '–í–û–ó–ú–û–ñ–ù–û' // –¢–µ–∫—Å—Ç –≤–º–µ—Å—Ç–æ %
    }));
    const times = calcResults.map(r => Number(r.incub_time)).filter(t => t > 0);
    minTime = times.length ? formatTime(Math.min(...times)) : '‚Äî';
  } else {
    calcResults = [];
    minTime = '';
  }

  // GUIDE
  let guideResults: any[] = [];
  let isSearching = false;

  $: if (mode === 'reverse' && target) {
    isSearching = true;
    guideResults = [];
    setTimeout(() => {
        const res = findParentsFor(target!, allMutants);
        guideResults = res.map(r => ({
            p1: r.p1,
            p2: r.p2,
            isSecret: r.isSecret,
            tag: r.isSecret ? '–†–ï–¶–ï–ü–¢' : '–ü–ê–†–´'
        }));
        isSearching = false;
    }, 50);
  }

  // CARD CLICK
  function handleCardClick(m: Mutant) {
    const isSecret = secretNames.has(normalize(getName(m)));

    // –£–º–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –≤ –ì–∏–¥
    if (filterGene === 'recipe' || (isSecret && mode === 'reverse')) {
        mode = 'reverse';
        target = m;
        return;
    }

    if (mode === 'calc') {
      if (!p1) p1 = m;
      else if (!p2 && p1.id !== m.id) p2 = m;
      else if (p1.id === m.id) p1 = null;
      else if (p2?.id === m.id) p2 = null;
      else { p1 = m; p2 = null; }
    } else {
      target = target?.id === m.id ? null : m;
    }
  }
</script>

<div class="flex flex-col lg:flex-row w-full min-h-[80vh] gap-6 font-sans pb-20">

  <!-- LEFT PANEL -->
  <div class="flex-1 min-w-0 flex flex-col gap-6">

    <!-- HEADER -->
    <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 flex flex-col sm:flex-row justify-between items-center gap-4 shadow-lg relative overflow-hidden">
        <div class="absolute top-0 left-0 h-full w-1 bg-gradient-to-b from-lime-500 to-emerald-600"></div>
        <div class="flex items-center gap-3 z-10">
            <div class="h-10 w-10 rounded-lg bg-gradient-to-br from-lime-500 to-emerald-600 flex items-center justify-center shadow-lg shadow-lime-500/20 text-xl">üß¨</div>
            <div>
                <h1 class="text-lg font-black uppercase text-white tracking-wider leading-none">Bio-Lab</h1>
                <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-0.5">–°–∏–º—É–ª—è—Ç–æ—Ä v5.0</div>
            </div>
        </div>
        <div class="flex flex-wrap justify-center gap-2 z-10">
            <div class="flex bg-slate-950 p-1 rounded-lg border border-slate-800">
                <button class="px-5 py-1.5 rounded-md text-[10px] font-black uppercase tracking-wider transition-all {mode==='calc' ? 'bg-lime-500 text-black shadow-lg' : 'text-slate-500 hover:text-white'}"
                    on:click={() => { mode='calc'; target=null; }}>–°–∏–º—É–ª—è—Ç–æ—Ä</button>
                <button class="px-5 py-1.5 rounded-md text-[10px] font-black uppercase tracking-wider transition-all {mode==='reverse' ? 'bg-purple-500 text-white shadow-lg' : 'text-slate-500 hover:text-white'}"
                    on:click={() => { mode='reverse'; p1=null; p2=null; }}>–ì–∏–¥</button>
            </div>
            <!-- Level Selector (Decorative) -->
            <div class="flex items-center gap-2 bg-slate-950 px-3 py-1.5 rounded-lg border border-slate-800">
                <span class="text-[10px] uppercase font-bold text-slate-500">–ë–∞–∑–∞:</span>
                <select bind:value={level} class="bg-transparent text-xs font-bold text-lime-400 focus:outline-none cursor-pointer uppercase">
                    <option value="1">LVL 1</option>
                    <option value="2">LVL 2</option>
                    <option value="3">LVL 3</option>
                </select>
            </div>
        </div>
    </div>

    <!-- CALC -->
    {#if mode === 'calc'}
        <div class="grid grid-cols-[1fr_auto_1fr] gap-3 sm:gap-8 items-center">
            <button class="relative group w-full aspect-[3/4] sm:aspect-square max-w-[200px] mx-auto bg-slate-800/30 border-2 border-dashed {p1 ? 'border-lime-500 bg-slate-800' : 'border-slate-700 hover:border-slate-500'} rounded-2xl flex flex-col items-center justify-center transition-all overflow-hidden"
                on:click={() => p1 = null}>
                {#if p1}
                    <img src={getImageSrc(p1)} class="w-3/4 h-3/4 object-contain drop-shadow-2xl z-10" alt=""/>
                    <div class="absolute bottom-0 inset-x-0 p-2 bg-black/80 backdrop-blur-md text-center">
                        <div class="text-xs font-bold text-white truncate uppercase">{getName(p1)}</div>
                    </div>
                    <div class="absolute top-2 right-2 text-slate-500 hover:text-red-400 z-20">‚úï</div>
                {:else}
                    <div class="text-4xl text-slate-600 font-thin mb-2">+</div>
                    <div class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">–†–æ–¥–∏—Ç–µ–ª—å 1</div>
                {/if}
            </button>

            <div class="flex justify-center opacity-20"><img src="/mut_icons/icon_morphology.webp" class="w-8 h-8 animate-pulse" alt="+"/></div>

            <button class="group relative w-full aspect-[3/4] sm:aspect-square max-w-[200px] mx-auto bg-slate-800/30 border-2 border-dashed {p2 ? 'border-lime-500 bg-slate-800' : 'border-slate-700 hover:border-slate-500'} rounded-2xl flex flex-col items-center justify-center transition-all overflow-hidden"
                on:click={() => p2 = null}>
                {#if p2}
                    <img src={getImageSrc(p2)} class="w-3/4 h-3/4 object-contain drop-shadow-2xl z-10" alt=""/>
                    <div class="absolute bottom-0 inset-x-0 p-2 bg-black/80 backdrop-blur-md text-center">
                        <div class="text-xs font-bold text-white truncate uppercase">{getName(p2)}</div>
                    </div>
                    <div class="absolute top-2 right-2 text-slate-500 hover:text-red-400 z-20">‚úï</div>
                {:else}
                    <div class="text-4xl text-slate-600 font-thin mb-2">+</div>
                    <div class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">–†–æ–¥–∏—Ç–µ–ª—å 2</div>
                {/if}
            </button>
        </div>

        {#if p1 && p2}
            <div class="animate-in slide-in-from-bottom-4 duration-500">
                {#if calcResults.length > 0}
                    <div class="bg-slate-900 border border-slate-700 rounded-2xl overflow-hidden shadow-2xl">
                        <div class="flex justify-between items-center px-5 py-3 bg-slate-950 border-b border-slate-800">
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã: <span class="text-white">{calcResults.length}</span></span>
                            <span class="text-xs font-mono text-slate-500">–º–∏–Ω. {minTime}</span>
                        </div>
                        <div class="divide-y divide-slate-800 max-h-[500px] overflow-y-auto custom-scrollbar">
                            {#each calcResults as r}
                                <button class="w-full flex items-center gap-4 p-4 hover:bg-slate-800 transition-colors text-left group"
                                    on:click={() => window.dispatchEvent(new CustomEvent('openMutant', {detail:{mutant:r}}))}>

                                    <div class="relative w-16 h-16 shrink-0 rounded-xl bg-slate-950 border border-slate-700 overflow-hidden shadow-lg group-hover:scale-105 transition-transform">
                                        <img src={getImageSrc(r)} class="w-full h-full object-cover" alt=""/>
                                    </div>

                                    <div class="flex-1 min-w-0 flex flex-col justify-center gap-1">
                                        <div class="flex items-center gap-2">
                                            <span class="font-bold text-base text-slate-200 group-hover:text-white truncate">{getName(r)}</span>
                                            {#if r.isSecret}<span class="text-[9px] bg-fuchsia-500/10 text-fuchsia-400 border border-fuchsia-500/30 px-1.5 rounded uppercase font-bold">–°–µ–∫—Ä–µ—Ç</span>{/if}
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <div class="flex -space-x-1.5">
                                                {#each ((Array.isArray(r.genes)?r.genes[0]:r.genes)||'').split('') as g}
                                                    <img src={getGeneIconSrc(g)} class="w-4 h-4 rounded-full bg-black ring-2 ring-slate-900 relative z-10" alt={g}/>
                                                {/each}
                                            </div>
                                            <img src={getTypeIcon(r)} class="w-4 h-4 opacity-50" alt=""/>
                                        </div>
                                    </div>

                                    <div class="text-right shrink-0 flex flex-col items-end gap-1">
                                        <div class="font-black text-xs uppercase {r.isSecret ? 'text-fuchsia-400' : 'text-lime-400'} tracking-widest">{r.tag}</div>
                                        <div class="flex items-center gap-1 text-sm text-slate-400 font-bold font-mono bg-slate-950/50 px-2 py-1 rounded border border-white/5">
                                            <span>‚è±</span> {formatTime(r.incub_time)}
                                        </div>
                                    </div>
                                </button>
                            {/each}
                        </div>
                    </div>
                {:else}
                    <div class="p-8 text-center bg-slate-900/50 border border-dashed border-slate-700 rounded-2xl text-slate-400 text-sm">
                        –ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è.
                    </div>
                {/if}
            </div>
        {/if}

    <!-- GUIDE -->
    {:else}
        <div class="animate-in slide-in-from-bottom-4 duration-500">
            {#if !target}
                <div class="border-2 border-dashed border-slate-700 bg-slate-900/20 rounded-2xl p-10 text-center">
                    <div class="text-4xl mb-3 opacity-20 grayscale">üîç</div>
                    <div class="text-sm font-bold text-slate-400">–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å —Å–ø—Ä–∞–≤–∞</div>
                </div>
            {:else}
                <div class="relative flex items-center gap-5 p-5 bg-slate-900 rounded-2xl border border-purple-500/30 shadow-lg mb-6 overflow-hidden">
                    <div class="absolute right-0 top-0 p-4 opacity-10 pointer-events-none">
                        <img src={getTypeIcon(target)} class="w-32 h-32" alt=""/>
                    </div>
                    <div class="w-20 h-20 shrink-0 rounded-xl bg-slate-950 border border-slate-800 shadow-xl overflow-hidden z-10">
                        <img src={getImageSrc(target)} class="w-full h-full object-cover" alt=""/>
                    </div>
                    <div class="z-10">
                        <div class="text-[10px] font-black uppercase text-purple-400 tracking-widest mb-1">–¶–µ–ª—å</div>
                        <div class="text-2xl font-black text-white leading-none">{getName(target)}</div>
                        <button class="text-xs text-slate-500 hover:text-white underline mt-2" on:click={() => target=null}>–°–º–µ–Ω–∏—Ç—å</button>
                    </div>
                </div>

                {#if isSearching}
                    <div class="p-10 text-center">
                        <div class="inline-block w-6 h-6 border-2 border-lime-500 border-t-transparent rounded-full animate-spin mb-2"></div>
                        <div class="text-xs font-bold text-lime-500 uppercase tracking-widest">–ü–æ–∏—Å–∫ –î–ù–ö...</div>
                    </div>
                {:else if guideResults.length > 0}
                    <div class="grid gap-2">
                        {#each guideResults as pair}
                            <div class="flex items-center justify-between p-3 bg-slate-900 border border-slate-800 rounded-xl hover:border-purple-500/40 transition-all">
                                <div class="flex items-center gap-3">
                                    <div class="flex -space-x-2">
                                        <img src={getImageSrc(pair.p1)} class="w-10 h-10 rounded-full bg-slate-950 border-2 border-slate-800 z-10 object-cover" alt=""/>
                                        <img src={getImageSrc(pair.p2)} class="w-10 h-10 rounded-full bg-slate-950 border-2 border-slate-800 z-0 object-cover" alt=""/>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-xs font-bold text-slate-300">{getName(pair.p1)}</span>
                                        <span class="text-[10px] text-slate-500">+ {getName(pair.p2)}</span>
                                    </div>
                                </div>
                                <div class="font-black text-xs uppercase {pair.isSecret ? 'text-fuchsia-400' : 'text-lime-400'} tracking-widest">
                                    {pair.tag}
                                </div>
                            </div>
                        {/each}
                    </div>
                {:else}
                    <div class="p-8 text-center bg-slate-900 rounded-xl border border-slate-700 text-sm text-slate-400">
                        <div class="text-2xl mb-2">üîí</div>
                        –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ (–ú–∞–≥–∞–∑–∏–Ω/–ê–∫—Ü–∏—è/–ü–í–ü).
                    </div>
                {/if}
            {/if}
        </div>
    {/if}
  </div>

  <!-- RIGHT SIDEBAR -->
  <div class="w-full lg:w-[320px] lg:shrink-0 flex flex-col gap-4 lg:border-l border-slate-800 lg:pl-6 pt-6 lg:pt-0 border-t lg:border-t-0">
    <div class="sticky top-0 z-20 bg-[#0f172a] pb-2 space-y-2">
        <div class="relative">
            <input type="text" bind:value={search} placeholder="–ù–∞–π—Ç–∏ –º—É—Ç–∞–Ω—Ç–∞..."
                class="w-full bg-slate-900 border border-slate-700 text-sm text-white rounded-lg pl-9 pr-4 py-2.5 focus:border-lime-500 focus:ring-1 focus:ring-lime-500 focus:outline-none transition-all placeholder-slate-600"/>
            <span class="absolute left-3 top-3 text-slate-500 text-xs">üîç</span>
        </div>
        <div class="flex flex-wrap gap-1.5">
            <button class="px-3 h-7 rounded text-[10px] font-bold uppercase border transition-all {filterGene==='all' ? 'bg-white text-black border-white' : 'bg-slate-900 text-slate-500 border-slate-700 hover:border-slate-500'}"
                on:click={() => filterGene='all'}>All</button>
            {#each ['A','B','C','D','E','F'] as g}
                <button class="w-7 h-7 flex items-center justify-center rounded border transition-all {filterGene===g ? 'border-lime-500 bg-slate-800 shadow-lg shadow-lime-500/20' : 'bg-slate-900 border-slate-700 opacity-50 hover:opacity-100 hover:border-slate-500'}"
                    on:click={() => filterGene=g}>
                    <img src={getGeneIconSrc(g)} class="w-3.5 h-3.5" alt={g}/>
                </button>
            {/each}
            <!-- RECIPES BUTTON -->
            <button class="w-7 h-7 flex items-center justify-center rounded border transition-all {filterGene==='recipe' ? 'border-orange-500 bg-slate-800 shadow-lg shadow-orange-500/20' : 'bg-slate-900 border-slate-700 opacity-50 hover:opacity-100 hover:border-slate-500'}"
                on:click={() => filterGene='recipe'} title="–°–µ–∫—Ä–µ—Ç—ã">
                <img src="/mut_icons/icon_recipe.webp" class="w-3.5 h-3.5" alt="‚òÖ"/>
            </button>
        </div>
    </div>

    <div class="grid grid-cols-4 sm:grid-cols-5 lg:grid-cols-3 gap-2 overflow-y-auto h-[500px] lg:h-[calc(100vh-150px)] custom-scrollbar pr-2 content-start">
        {#each filteredList as m (m.id)}
            <button class="group relative w-full bg-slate-900 border border-slate-800 rounded-xl overflow-hidden hover:border-lime-500/50 hover:shadow-lg transition-all focus:outline-none focus:ring-2 focus:ring-lime-500"
                style="padding-top: 100%;"
                on:click={() => handleCardClick(m)}>
                <div class="absolute inset-0">
                    <img loading="lazy" src={getImageSrc(m)} class="w-full h-full object-cover opacity-80 group-hover:opacity-100 group-hover:scale-110 transition-transform duration-500" alt=""/>
                </div>
                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent"></div>
                <div class="absolute bottom-0 inset-x-0 p-1">
                    <div class="text-[9px] text-center text-slate-300 font-bold truncate leading-tight group-hover:text-white">{getName(m)}</div>
                </div>
                {#if getTypeIcon(m)}
                    <img src={getTypeIcon(m)} class="absolute top-1 right-1 w-3.5 h-3.5 drop-shadow-md opacity-90" alt=""/>
                {/if}
            </button>
        {/each}
    </div>
  </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }
</style>
