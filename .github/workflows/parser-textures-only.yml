name: Parser - Textures Only Mode

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  textures-job:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: npm ci

      - name: 4. –ó–∞–ø—É—Å–∫ –ü–∞—Ä—Å–µ—Ä–∞ (–†–µ–∂–∏–º TEXTURES-ONLY)
        run: npx tsx scripts/sync-mutants.ts textures-only

      - name: 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        id: check-changes
        run: |
          if git diff --quiet public/textures_by_mutant/ 2>/dev/null; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–æ–≤—ã–µ —Ç–µ–∫—Å—Ç—É—Ä—ã"
          fi

      - name: 6. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π (Commit & Push)
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ü§ñ Parser Textures: –î–æ–∫–∞—á–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö —Ç–µ–∫—Å—Ç—É—Ä"
          commit_user_name: "MGG Parser Bot"
          commit_user_email: "bot@archivist-library.com"
          commit_author: "MGG Parser Bot <bot@archivist-library.com>"
          branch: main
          file_pattern: 'public/textures_by_mutant/**/*.webp'

      - name: 7. –ò—Ç–æ–≥–∏ —Ä–∞–±–æ—Ç—ã
        if: always()
        run: |
          echo "## üìä –ò—Ç–æ–≥–∏ –ø–∞—Ä—Å–µ—Ä–∞ (TEXTURES-ONLY)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-changes.outputs.has_changes }}" == "true" ]; then
            echo "‚úÖ **–°—Ç–∞—Ç—É—Å:** –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–æ–≤—ã–µ —Ç–µ–∫—Å—Ç—É—Ä—ã, —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ÑπÔ∏è **–°—Ç–∞—Ç—É—Å:** –í—Å–µ —Ç–µ–∫—Å—Ç—É—Ä—ã –Ω–∞ –º–µ—Å—Ç–µ, –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üïê **–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "‚è±Ô∏è **–†–µ–∂–∏–º –ø–∞—Ä—Å–µ—Ä–∞:** TEXTURES-ONLY (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–æ–∫–∞—á–∫–∞ —Ç–µ–∫—Å—Ç—É—Ä —É –≤—Å–µ—Ö –º—É—Ç–∞–Ω—Ç–æ–≤)" >> $GITHUB_STEP_SUMMARY
