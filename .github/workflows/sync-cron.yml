name: Auto-Sync Mutants

on:
  schedule:
    # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 16:30 –ú–°–ö (13:30 UTC)
    - cron: '30 13 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-job:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: npm ci

      - name: 4. –ó–∞–ø—É—Å–∫ –ü–∞—Ä—Å–µ—Ä–∞ (–†–µ–∂–∏–º FULL)
        run: npx tsx scripts/sync-mutants.ts full

      - name: 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        id: check-changes
        run: |
          if git diff --quiet src/data/mutants/*.json public/textures_by_mutant/ 2>/dev/null; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –¥–∞–Ω–Ω—ã—Ö"
          fi

      - name: 6. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π (Commit & Push)
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ü§ñ Auto-Sync: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –º—É—Ç–∞–Ω—Ç–æ–≤"
          commit_user_name: "MGG Parser Bot"
          commit_user_email: "bot@archivist-library.com"
          commit_author: "MGG Parser Bot <bot@archivist-library.com>"
          branch: main
          file_pattern: 'src/data/mutants/*.json public/textures_by_mutant/**'

      - name: 7. –ò—Ç–æ–≥–∏ —Ä–∞–±–æ—Ç—ã
        if: always()
        run: |
          echo "## üìä –ò—Ç–æ–≥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-changes.outputs.has_changes }}" == "true" ]; then
            echo "‚úÖ **–°—Ç–∞—Ç—É—Å:** –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è, –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ÑπÔ∏è **–°—Ç–∞—Ç—É—Å:** –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üïê **–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "‚è±Ô∏è **–†–µ–∂–∏–º –ø–∞—Ä—Å–µ—Ä–∞:** FULL (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –º—É—Ç–∞–Ω—Ç–æ–≤)" >> $GITHUB_STEP_SUMMARY
